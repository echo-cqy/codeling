## 设计原则（最小影响）
- 保持现有 UI/交互与 state 结构不变：App.tsx 仍以 `questions/stats/lang/selectedQuestion` 驱动。
- 先“抽象边界”，再“替换实现”：先把 localStorage 访问集中到一个可替换的接口里，确保第一阶段重构不改变任何功能。
- 分阶段上线，每阶段都可独立部署且可回滚：任何新能力都通过开关或条件渲染接入，避免一次性大改。

## 第 0 阶段：只做无行为变更的重构（1 次部署）
### 0.1 引入存储门面（Facade）
- 目标：把 `storageService` 的调用点收敛，App/组件不再直接依赖 localStorage 细节。
- 做法：
  - 定义 `IStorageService` 接口（方法集合对齐现有 storageService：getStats/getQuestions/saveAttempt/addQuestion/deleteQuestion/getDraft/saveDraft/saveProfile/saveAIConfig/clearAllData/getLang/setLang 等）。
  - 实现 `LocalStorageService`：把现有 storageService.ts 的逻辑原样迁移/封装（对外行为完全一致）。
  - 在 App.tsx 里只从一个地方获取 `storage` 实例（例如 `getStorage()`），其余组件通过 props 或 context 取用。
- 验证：本地对比关键流程（做题保存、切换题目、导入、删除、历史、草稿）无变化。

### 0.2 引入“用户会话容器”但不启用登录
- 目标：提前为鉴权接入预留位置，不改现有页面结构。
- 做法：增加 `AuthContext`（初始永远是“未登录”），不影响业务。

## 第 1 阶段：接入登录/注册（但仍用本地存储）（1 次部署）
- 目标：先把登录能力跑通，不把数据迁移上云，降低风险。
- 推荐：Supabase Auth（邮箱+密码）。
- 前端改动最小化：
  - 增加一个 `AuthModal`（登录/注册切换），仅在用户点击“登录”按钮时弹出。
  - App 顶部增加一个轻量入口（右上角“登录/退出”），不引入路由、不拆页面。
  - 登录成功后只影响 UI 状态（展示用户名等），数据仍来自 `LocalStorageService`。
- 验证：注册/登录/退出/刷新会话恢复。

## 第 2 阶段：云端数据存储（先增量同步，后全量切换）（2 次部署）
### 2.1 先上云“最不易冲突”的数据
- 目标：减少一次性迁移风险。
- 优先顺序：profile、aiConfig、drafts（按 user_id 隔离）。
- 做法：
  - 新增 `RemoteStorageService`（Supabase DB 实现），但只实现上述 3 类数据。
  - `StorageFacade` 逻辑：已登录 -> 远端读写；未登录 -> 本地读写。
  - 组件侧不改调用方式。

### 2.2 再上云核心业务数据（questions/attempts）
- 目标：跨设备同步题库与做题历史。
- 做法：
  - 在 DB 设计 questions/attempts 表，并写转换函数：DB row ⇄ 现有 `Question/Attempt/UserStats` 结构。
  - `getStats()` 与 `getQuestions()` 在登录态优先拉远端；写入走 upsert。
  - 保留本地缓存（可选）：远端拉取成功后写回 localStorage，作为离线回退与加速。

## 第 3 阶段：数据迁移（可选提示，不强制）（1 次部署）
- 目标：不破坏老用户本地数据。
- 做法：
  - 检测：用户首次登录且远端无数据时，弹出“是否导入本地数据到云端”。
  - 导入策略：questions/attempts/drafts/profile/aiConfig 逐表 upsert；成功后提示是否清空本地。
- 验证：新设备登录能看到导入的数据；不同账号数据隔离。

## 权限与安全（方案 A 的关键点）
- Supabase RLS：所有业务表都限制 `auth.uid() = user_id`。
- 前端只用 anon key；任何需要更高权限的操作（如管理/全站数据）不在前端做。

## Netlify 部署与配置
- 环境变量：VITE_SUPABASE_URL、VITE_SUPABASE_ANON_KEY。
- 仍使用静态站部署；构建命令保持 `npm run build`，publish `dist`。

## 验证清单（每阶段都做）
- `npm run build` 必须通过。
- 登录态与未登录态都能完成：保存草稿/保存 attempt/新增删除题/导入题库。
- 两个账号互相看不到对方的数据。

## 里程碑式交付（确保最小影响）
- 交付 0：仅重构边界，无功能变化。
- 交付 1：登录/注册可用，但数据仍本地（最安全）。
- 交付 2：登录后云端同步（先 profile/草稿，再题库/历史）。
- 交付 3：提供一次性导入本地数据。

确认后我会按上述“0→1→2→3”的顺序实施，每一步都保证可构建、可部署、可回滚。